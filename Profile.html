<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Itemslist</title>
  <link href="ProfileCss.css" rel="stylesheet" type="text/css"/>
  <link rel="icon" type="image/x-icon" href="Images/newlogo.png">

  <!--Google Fonts-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>
<body onload="GetHistory()">
    <nav>
    <!--KTI Logo and Title-->
    <p class="navMainText">
      <img id="navImage" src="Images/newlogo.png" width="100" alt="drawing of a welder">
      Keefe Tech Inventory
    </p>

    <br>

    <!--Navigation Bar-->
    <div class="topnav" id="myTopnav">
      <a href="../class.html"><b><i>CLASSES</a></b></i>
      <a href="../itemlist.html"><b><i>ITEMS</a></b></i>
    </div>
  </nav>
    <h1 class="profileTitle"><i>Manage Your Account</i></h1>
    <div class="profileContainer">
        <div class="profileDetails">
            <h2><i>Name:</i> Jam</h2>
            <h2><i>Email:</i></h2>
            <h2><i>Account Type:</i> Student Account</h2>
        </div>
        <div class="profilePicture">
            <img src="Images/metalIcon.jpg" width="150" alt="placeholder">
        </div>
    </div>
    <div class="historySection">
        <h2><i>History</i></h2>
        <div class="historyContainer" id="historyContainer">
            <!-- History items will be appended here -->
        </div>
    </div>
    <script>
        // Fetch the current user's history from the backend and render it into
        // #historyContainer. This runs on page load.
        async function GetHistory(){
            const container = document.getElementById("historyContainer");
            container.innerHTML = "<p><i>Loading history...</i></p>";
            try {
                const response = await fetch("https://develmets.skiscratcher.com/getMyHistory", {
                    method: "GET",
                    credentials: "include"
                });

                if (!response.ok) {
                    container.innerHTML = "<h3><i>No History Found</i></h3>";
                    return;
                }

                const history = await response.json();
                if (!Array.isArray(history) || history.length === 0) {
                    container.innerHTML = "<h3><i>No History Found</i></h3>";
                    return;
                }

                // Clear and populate
                container.innerHTML = "";
                history.forEach(historyItem => {
                    const row = document.createElement("div");
                    row.className = "historyRow";
                    row.style.display = "flex";
                    row.style.alignItems = "center";
                    row.style.marginBottom = "8px";

                    // timeTaken / timeReturned may be timestamps or ISO strings.
                    const taken = historyItem.timeTaken ? new Date(historyItem.timeTaken).toLocaleString() : "-";
                    const returned = historyItem.timeReturned ? new Date(historyItem.timeReturned).toLocaleString() : "-";

                    row.innerHTML = `
                        <div style="flex: 1;"><i>Item ID:</i> ${historyItem.toolId}</div>
                        <div style="flex: 1;"><i>Time Taken:</i> ${taken}</div>
                        <div style="flex: 1;"><i>Time Returned:</i> ${returned}</div>`;
                    container.appendChild(row);
                });

            } catch (err) {
                console.error('Failed to load history', err);
                container.innerHTML = "<h3><i>Error loading history</i></h3>";
            }
        }

        // Also ensure history is loaded on DOMContentLoaded in case onload was not fired
        window.addEventListener('DOMContentLoaded', GetHistory);
    </script>
</body>
</html>