<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>User Management Dashboard</title>
    <link href="classStyle.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/x-icon" href="Images/newlogo.png">
    <!-- Google Fonts for Oswald -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  </head>
  <body>
    <nav>
    <!--KTI Logo and Title-->
    <p class="navMainText">
      <img id="navImage" src="Images/newlogo.png" width="100" alt="drawing of a welder">
      Keefe Tech Inventory - users
    </p>

    <br>
    <!--Navigation Bar-->
    <div class="topnav" id="myTopnav">
      <a href="itemlist.html"><b><i>Items</a></b></i>
      <a href="class.html"><b><i>Classes</a></b></i>
      <a href="javascript:void(0);" class="icon" onclick="myFunction()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
      
  </nav>

    <main style="margin-top:64px;">
      <h3>Unapproved Users</h3>
      <div id="userList"></div>
    </main>

    <script>
      // Fetch and display users with userType 0
      async function fetchAndRenderUsers() {
        const userListDiv = document.getElementById("userList");
        userListDiv.innerHTML = "<b>Loading users...</b>";
        try {
          const response = await fetch("https://develmets.skiscratcher.com/users", {
            method: "GET",
            credentials: "include"
          });
          if (!response.ok) {
            userListDiv.innerHTML = "<b>Failed to fetch users.</b>";
            return;
          }

          const users = await response.json();

          // Filter users with userType == 0
          const unapprovedUsers = users.filter(user => user.userType == 0);

          if (unapprovedUsers.length === 0) {
            userListDiv.innerHTML = "<b>No unapproved users.</b>";
            return;
          }

          userListDiv.innerHTML = "";

          unapprovedUsers.forEach(user => {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.alignItems = "center";
            row.style.marginBottom = "8px";

            // Approve button
            const approveBtn = document.createElement("button");
            approveBtn.textContent = "Approve";
            approveBtn.style.marginRight = "12px";
            approveBtn.onclick = function() {
              approveUser(user.userId);
            };
            row.appendChild(approveBtn);

            // User info
            const info = document.createElement("span");
            info.textContent = `${user.displayName} (${user.email})`;
            row.appendChild(info);

            userListDiv.appendChild(row);
          });
        } catch (err) {
          userListDiv.innerHTML = "<b>Error loading users.</b>";
        }
      }

      // Approve user by calling the endpoint
      async function approveUser(userId) {
        try {
          const response = await fetch("https://develmets.skiscratcher.com/approval", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ approveid: userId }),
            credentials: "include"
          });
          if (!response.ok) {
            alert("Failed to approve user.");
            return;
          }
          // On success, refresh the list
          fetchAndRenderUsers();
        } catch (err) {
          alert("Error approving user: " + err);
        }
      }

      // Initialize on page load
      window.addEventListener("DOMContentLoaded", fetchAndRenderUsers);
    </script>
  </body>
</html>
