<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Class Management Dashboard</title>
    <link href="classStyle.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/x-icon" href="images/Logo.png">
    <!-- Google Fonts for Oswald -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  </head>
    <!--jimmy-->
  <body>
    <nav>
    <!--KTI Logo and Title-->
    <p class="navMainText">
      <img id="navImage" src="Images/newlogo.png" width="100" alt="drawing of a welder">
      Keefe Tech Inventory - classes
    </p>

    <br>
    <!--Jimmy-->
    <!--Navigation Bar-->
    <div class="topnav" id="myTopnav">
      <a href="../itemlist.html"><b><i>Items</a></b></i>
      <a href="javascript:void(0);" class="icon" onclick="myFunction()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
      
  </nav>

    <main style="margin-top:64px;">
      <div id="addClass">
        <label for="cName">Class Name</label><br>
        <input type="text" id="cName" name="cName" placeholder="Enter new class name"><br>
        <button onclick="addClass()">Add Class</button>
      </div>

      <div id="addStudents" style="margin-top:32px;">
        <h3>Add Student to Class</h3>
        <label for="sClass">Class</label><br>
        <select id="sClass" name="sClass"></select><br>
        <div id="userList" style="margin-top:18px;"></div>
      </div>

      <div style="margin-top:40px;">
        <h3>Classrooms & Students</h3>
        <div id="classrooms"></div>
      </div>
    </main>

    <script>
      /*
        Client-side state (in-memory):
        - classes: array of class objects returned from the backend. Each object has
          { className, id, classId } where id/classId come from the server.
        - studentsByClass: map keyed by classId -> array of student objects
          student object shape: { name, email, id } where id is the user's userid
        - tools: cached array of tools fetched from the backend (toolName, takenBy, etc.)
        - assignedStudentIds: Set of userids of students already assigned to any class
        - StudentId: unused placeholder array (kept for backward compatibility)
      */
      // Store classes and students in memory
      const classes = [];
      // studentsByClass[classId] = [ { name, email, id }, ... ]
      const studentsByClass = {};
      // cached tools from /getTools
      const tools = [];
      const StudentId = [];

      // Store students that have already been assigned to a class (userids)
      const assignedStudentIds = new Set();

      // Add a new class
      // Reads the class name from the `#cName` input and sends a POST to the backend
      // Side effects: clears the input and refreshes the class list on success
      async function addClass() {
  const cName = document.getElementById("cName").value.trim();
  if (!cName) {
    alert("Please enter a class name.");
    return;
  }
  // Send POST request to create class in the database
  try {
    const response = await fetch("https://develmets.skiscratcher.com/createClass", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ name: cName }),
      credentials: "include"
    });
    if (!response.ok) {
      alert("Failed to create class.");
      return;
    }
    document.getElementById("cName").value = "";
    await fetchAndRenderClasses(); // Update the UI with new classes from the database
  } catch (err) {
    alert("Error creating class: " + err);
  }
}

  // Fetch classes from the backend and refresh all UI that depends on classes
  // - Fetch /getClasses
  // - Populate `classes[]` and ensure `studentsByClass[classId]` exists
  // - Update the class select dropdown, fetch assigned students and tools,
  //   then render classrooms and the add-student list
  async function fetchAndRenderClasses() {
  try {
    const response = await fetch("https://develmets.skiscratcher.com/getClasses", {
      method: "GET",
      credentials: "include"
    });
    if (!response.ok) {
      alert("Failed to fetch classes.");
      return;
    }
    const classList = await response.json();
    // Update local classes and studentsByClass
    classes.length = 0;
    classList.forEach(cls => {
      // backend returns `classId` — use that consistently
      const id = cls.classId !== undefined ? cls.classId : cls.id;
      classes.push({ className: cls.className, id: id, classId: id });
      if (!studentsByClass[id]) studentsByClass[id] = [];
    });
    updateClassDropdown();
    await fetchAssignedStudents();
  await fetchTools();
    renderClassrooms();
    renderUserList();
  } catch (err) {
    alert("Error fetching classes: " + err);
  }
}

      // Update the class dropdown in the Add Student form
      // This writes one <option> per class. The option.value stores the backend classId
      // while the visible text is the human-readable className.
      function updateClassDropdown() {
        const sClassSelect = document.getElementById("sClass");
        sClassSelect.innerHTML = "";
        classes.forEach(cls => {
          const option = document.createElement("option");
          // store the classId (from backend) in the option value and show the name to the user
          option.value = cls.classId;
          option.textContent = cls.className;
          sClassSelect.appendChild(option);
        });
      }

      // Add a student locally to the selected class (UI-only helper)
      // NOTE: this function does not persist to the backend. It's useful for local
      // demos or when form fields exist for adding a student without server hookup.
      function addStudent() {
        const sName = document.getElementById("sName").value.trim();
        const sEmail = document.getElementById("sEmail").value.trim();
        const sClass = document.getElementById("sClass").value;
        if (!sName || !sEmail || !sClass) {
          alert("Please fill in all fields.");
          return;
        }
        studentsByClass[sClass].push({ name: sName, email: sEmail });
        document.getElementById("sName").value = "";
        document.getElementById("sEmail").value = "";
        renderClassrooms();
      }

      // Add student to class and persist to backend
      // Inputs:
      //  - user: a user object from /users (contains userid, displayName, email)
      //  - classId: numeric/string id representing the class (from the dropdown)
      // Behavior:
      //  - POSTs studentId and classId to /assignStudentToClass
      //  - On success updates local caches: assignedStudentIds and studentsByClass
      //  - Then re-renders classrooms and the user list
            async function addStudentToClass(user, classId) {
              try {
                // Use whichever id field the user object has (backend may return `userid` or `id`)
                const uid = user.userid !== undefined ? user.userid : user.id;

                const response = await fetch("https://develmets.skiscratcher.com/assignStudentToClass", {
                  method: "POST",
                  headers: { "Content-Type": "application/x-www-form-urlencoded" },
                  body: new URLSearchParams({ studentId: uid, classId: classId }),
                  credentials: "include"
                });

                if (!response.ok) {
                  alert("Failed to assign student to class.");
                  return;
                }

                // After the server confirms the assignment, re-fetch assigned users from the
                // backend so the authoritative user object will include the new classId.
                // fetchAssignedStudents() clears and repopulates local caches.
                await fetchAssignedStudents();

                // Re-render the UI from the refreshed, authoritative data
                renderClassrooms();
                renderUserList();
              } catch (err) {
                alert("Error assigning student: " + err);
              }
            }

      // Fetch tools and cache them in `tools` array.
      // Each tool is expected to contain fields such as: { toolName, takenBy, toolTypeId, ... }
      // We use `takenBy` to determine which student (userid) currently has the tool checked out.
      async function fetchTools() {
        try {
          const response = await fetch("https://develmets.skiscratcher.com/getTools", {
            method: "GET",
            credentials: "include"
          });
          if (!response.ok) return;
          const fetched = await response.json();
          // store the tools array (replace contents)
          tools.length = 0;
          fetched.forEach(t => tools.push(t));
        } catch (err) {
          // silently ignore network errors for now — UI will simply show no tools
        }
      }


      // Fetch assigned students for each class from backend
      // This populates `studentsByClass[classId]` and `assignedStudentIds`.
      // The /users endpoint returns an array of users; when a user has a class assignment
      // the object includes `classId` and `userid` which we use here.
      async function fetchAssignedStudents() {
        try {
          const response = await fetch("https://develmets.skiscratcher.com/users", {
            method: "GET",
            credentials: "include"
          });
          if (!response.ok) return;
          const assigned = await response.json();
          // Reset caches before repopulating to avoid duplicates
          assignedStudentIds.clear();
          Object.keys(studentsByClass).forEach(k => { studentsByClass[k] = []; });
          assigned.forEach(item => {
            const uid = item.userid !== undefined ? item.userid : item.id;
            assignedStudentIds.add(uid);
            if (!studentsByClass[item.classId]) studentsByClass[item.classId] = [];
            // keep a minimal student shape for display
            studentsByClass[item.classId].push({ name: item.displayName, email: item.email, id: uid });
          });
        } catch (err) {
          // Ignore errors for now
        }
      }
  let classIdToName = {};
// Fetch users and display them with add buttons (excluding already assigned students)
// Fetch users and display them with add buttons (excluding already assigned students)
  // Render the list of users (students) that can be added to a class.
  // Excludes users that are already assigned to a class (checked via assignedStudentIds).
  async function renderUserList() {
  const userListDiv = document.getElementById("userList");
  userListDiv.innerHTML = "<b>Loading users...</b>";
  try {
    const response = await fetch("https://develmets.skiscratcher.com/users", {
      method: "GET",
      credentials: "include"
    });
    if (!response.ok) {
      userListDiv.innerHTML = "<b>Failed to fetch users.</b>";
      return;
    }

    const users = await response.json();

    // Filter out admins and already assigned students
    const filtered = users.filter(user => user.userType == 1 && !assignedStudentIds.has(user.id));

    if (filtered.length === 0) {
      userListDiv.innerHTML = "<b>No students available to add.</b>";
      return;
    }

    userListDiv.innerHTML = "";

  filtered.forEach(user => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.marginBottom = "8px";

  // Add button (clicking assigns the user to the selected class)
      const addBtn = document.createElement("button");
      addBtn.textContent = "+";
      addBtn.style.marginRight = "12px";
      addBtn.onclick = function () {
        // the select stores the classId in its value — find the class and POST the assignment
        const sClass = document.getElementById("sClass").value;
        const classObj = classes.find(cls => String(cls.classId) === String(sClass));
        if (!classObj) {
          alert("Please select a class first.");
          return;
        }
        addStudentToClass(user, classObj.id);
      };
      row.appendChild(addBtn);

      // Student info with class name
      const info = document.createElement("span");
      const className = classIdToName[user.classId] || "No class assigned";
      info.textContent = `${user.displayName} (${user.email}) – Class: ${className}`;
      row.appendChild(info);

      userListDiv.appendChild(row);
    });
  } catch (err) {
    userListDiv.innerHTML = "<b>Error loading users.</b>";
  }
  }

// Render all classrooms and their students
      // Render all classrooms and their students
      // For each student we also list tools currently checked out by that student
      function renderClassrooms() {
        const container = document.getElementById("classrooms");
        container.innerHTML = "";
        classes.forEach(cls => {
          const classDiv = document.createElement("div");
          classDiv.className = "classroom-block";
          classDiv.style.marginBottom = "32px";
          classDiv.innerHTML = `<h4 style="color:#d32f2f;">${cls.className}</h4>`;
          const table = document.createElement("table");
          table.className = "classTable";
          table.style.width = "100%";
          table.innerHTML = `
            <tr>
              <th>Student Name</th>
              <th>Email</th>
              <th>Checked Out Tools</th>
            </tr>
          `;
          // Iterate the students assigned to this classId and produce one row each
          (studentsByClass[cls.classId] || []).forEach(student => {
            const row = document.createElement("tr");
            // find tools checked out by this student: compare takenBy to the stored id fields
            const taken = tools.filter(t => String(t.takenBy) === String(student.id) || String(t.takenBy) === String(student.userid));
            const takenNames = taken.map(t => t.toolName).join(", ");
            row.innerHTML = `<td>${student.name}</td><td>${student.email}</td><td>${takenNames}</td>`;
            table.appendChild(row);
          });
          classDiv.appendChild(table);
          container.appendChild(classDiv);
        });
      }


// Initialize dropdown and fetch classes/students on page load
window.addEventListener("DOMContentLoaded", fetchAndRenderClasses);

// Also call renderUserList when the class dropdown changes
document.getElementById("sClass").addEventListener("change", renderUserList);
    </script>
  </body>
</html>