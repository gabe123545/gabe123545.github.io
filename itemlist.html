<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Itemslist</title>
  <link href="itemstyle.css" rel="stylesheet" type="text/css"/>
  <link rel="icon" type="image/x-icon" href="images/newlogo.png">

  <!--Google Fonts-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>
  
<body>
  <nav>
    <!--KTI Logo and Title-->
    <p class="navMainText">
      <img id="navImage" src="images/newlogo.png" width="100" alt="drawing of a welder">
      Keefe Tech Inventory
    </p>

    <br>

    <!--Navigation Bar-->
    <div class="topnav" id="myTopnav">
      <a href="../keefeTechInv/class.html"><b><i>CLASSES</a></b></i>
      <a href="#items"><b><i>ITEMS</a></b></i>
      <a href="javascript:void(0);" class="icon" onclick="myFunction()">
        <i class="fa fa-bars"></i>
      </a>
      <!--Profile Button-->
      <button class="open-button" onclick="openForm()">Profile</button>
    </div>
      
  </nav>

  <div class="form-popup" id="myForm">
    <form action="/action_page.php" class="form-container">
      <h1><i>Profile</h1></i>

      <!--Your name will display -->
      <h4 id="Name">Jam</h4>
      <!--profile pic will display-->
      <div class="prof">
        <button type="button" class="pfp" onclick="closeForm()"><img src="Images/metalIcon.jpg" width="80" alt="placeholder"></button>
      </div>
      <!--displays the email-->
      <h4 id="Email">jam@jpkeefehs.org</h4>
      <!--What type of account they have (student or admin)-->
      <h5 id="Account">Student Account</h5>
      <button type="button" class="btn Manage account" onclick="closeForm()">Manage Account</button> 
      <!--Log out of your account and bring you back to the login page--> 
      <button type="button" class="btn logout" onclick="logout()" >logout</button>
      <!--Closes the profile button and goes back to the item page-->
      <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
    </form>
  </div>

  <!-- Grid Container For The Script To Append To -->
  <div class="grid-container "> 
    
  </div>  
  

  <button class="tool-button buttonOrange" onclick="openItemForm()">+</button>
  <div class="tool-popup" id="myItemForm">
    <form class="tool-container" id="toolForm">
      <!-- Example fields, update as needed -->
      <label for="nameInput">Tool Name</label>
      <input type="text" id="nameInput" name="nameInput" required>
      <label for="quantityInput">Quantity</label>
      <input type="number" id="quantityInput" name="quantityInput" required min="0">
      <button type="button" onclick="itemSpawn()">Add Tool</button>
      <button type="button" onclick="closeItemForm()" style="background:#b71c1c;margin-top:0;">Cancel</button>
    </form>
  </div>

<script>


async function loadTools() {
    try {
      const response = await fetch("https://develmets.skiscratcher.com/getTools", {
        method: "GET",
        credentials: "include"
      });

      if (!response.ok) {
        console.error("Failed to fetch tools:", response.status);
        return;
      }

      const tools = await response.json();

      const container = document.querySelector(".grid-container");
      container.innerHTML = ""; // Clear existing items

      tools.forEach(tool => {
        const cardBtn = document.createElement("button");
        const cardBorder = document.createElement("div");
        const innerCardText = document.createElement("p");
        const RemoveBtn = document.createElement("button");

        cardBorder.classList.add("border");
        cardBtn.classList.add("grid-item");

        innerCardText.innerText = `${tool.toolName} - Amount: ${tool.quantity}`;
        cardBorder.appendChild(innerCardText);

        // Add Remove button inside the border
        RemoveBtn.innerText = "Remove";
        RemoveBtn.classList.add("remove-btn");
        RemoveBtn.dataset.toolTypeId = tool.toolTypeID; // Attach tool ID to button

        RemoveBtn.onclick = async function (e) {
        e.stopPropagation();
        e.preventDefault();

        if (confirm(`Are you sure you want to remove ${tool.toolName}?`)) {
          try {
            const toolId = RemoveBtn.dataset.toolId;

            const response = await fetch(`https://develmets.skiscratcher.com/removeToolType?id=${toolId}`, {
              method: "DELETE",
              credentials: "include"
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                await loadTools(); // refresh the list
              } else {
                alert("Failed to remove tool: " + result.msg);
              }
            } else {
              const text = await response.text();
              alert("Failed to remove tool: " + text);
            }
          } catch (err) {
            alert("Error removing tool: " + err);
          }
        }
      };


        cardBtn.appendChild(cardBorder);
        container.appendChild(cardBtn);
        cardBorder.appendChild(RemoveBtn); // <-- Place inside border
      });

    } catch (error) {
      console.error("Error loading tools:", error);
    }
  }

  // Call loadTools when the page loads
  window.addEventListener("DOMContentLoaded", loadTools);
  async function itemSpawn() {
  const nameInput = document.getElementById("nameInput").value.trim();
  const quantityInput = document.getElementById("quantityInput").value.trim();

  if (!nameInput || !quantityInput) {
    alert("Please fill in all fields.");
    return;
  }

  // Make sure quantity is a valid number
  if (isNaN(quantityInput) || parseInt(quantityInput) < 0) {
    alert("Quantity must be a non-negative number.");
    return;
  }

  const fd = new URLSearchParams({
    name: nameInput,
    quantity: quantityInput
  });

  try {
    const response = await fetch("https://develmets.skiscratcher.com/createToolType", {
      method: "POST",
      body: fd,
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      credentials: "include"
    });

    const responseText = await response.text();
    console.log("Backend response:", responseText);

    if (response.ok) {
      // Success path
      document.getElementById("nameInput").value = "";
      document.getElementById("quantityInput").value = "";
      closeItemForm();
      await loadTools();
    } else {
      // Error, but maybe item was still created
      if (responseText.toLowerCase().includes("created")) {
        // Treat as success
        document.getElementById("nameInput").value = "";
        document.getElementById("quantityInput").value = "";
        closeItemForm();
        await loadTools();
      } else {
        alert("Error adding tool: " + responseText);
      }
    }
  } catch (error) {
    console.error("Network or server error:", error);
    alert("Could not connect to the server.");
  }
}



  function openItemForm() {
    document.getElementById("myItemForm").classList.add("active");
  }
  function closeItemForm() {
    document.getElementById("myItemForm").classList.remove("active");
  }
  

  function openForm() {
    document.getElementById("myForm").style.display = "block";
  }
  function closeForm() {
    document.getElementById("myForm").style.display = "none";
  }
  async function logout() {
    try {
      // Call the remote backend logout endpoint
      const response = await fetch("https://develmets.skiscratcher.com/logout", {
        method: "GET", 
        credentials: "include"
      });

      if (response.ok) {
        console.log("Successfully logged out from remote server.");
        window.location.href = "login.html";
      } else {
        console.warn("Remote logout failed:", response.status);
      }
    } catch (error) {
      console.error("Logout request failed:", error);
    }
    

  }

  //Alert Invalid File Type Keeps Popping Up, No Preview Div Currently
  function fileValidation() { 
    var imageConvert = document.getElementById('imageInput');
    var imageValue = imageConvert.value;
    var allowExtension = /(\.jpg|\.jpeg|\.png)$/i;
      
    if (!allowExtension.exec(imageValue)) {
      alert('Invalid file type');
      imageConvert.value = '';
      return false;
    }
    else {
      if (imageConvert.files && imageConvert.files[0]) {
        var fileReader = new FileReader();
        fileReader.onload = function(e) {
          document.getElementById('imagePreview').innerHTML = '<img src="' + e.target.result + '"/>';
        };
        fileReader.readAsDataURL(imageConvert.files[0]);
      }
    }

  }
</script>
<script>
  function myFunction() {
    var x = document.getElementById("myTopnav");
    if (x.className === "topnav") {
      x.className += " responsive";
    } else {
      x.className = "topnav";
    }
} 
</script>

</body>

</html>